FROM nvidia/cuda:8.0-cudnn6-runtime

COPY ./keyboard /etc/default/keyboard

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  apt-utils \
  cuda-drivers

RUN mv /usr/lib/nvidia-375/libEGL.so.1 /usr/lib/nvidia-375/libEGL.so.1.org
RUN mv /usr/lib32/nvidia-375/libEGL.so.1 /usr/lib32/nvidia-375/libEGL.so.1.org
RUN ln -s /usr/lib/nvidia-375/libEGL.so.375.39 /usr/lib/nvidia-375/libEGL.so.1
RUN ln -s /usr/lib32/nvidia-375/libEGL.so.375.39 /usr/lib32/nvidia-375/libEGL.so.1
RUN ln -s /usr/lib/x86_64-linux-gnu/libcudnn.so.6 /usr/local/cuda/lib64/libcudnn.so.5

# General APT-GET instalations
RUN apt-get update && apt-get install -y --no-install-recommends \
  build-essential \
  cmake \
  cuda-command-line-tools-8-0 \
  cuda-core-8-0 \
  cuda-cublas-dev-8-0 \
  cuda-cudart-dev-8-0 \
  cuda-cufft-dev-8-0 \
  cuda-curand-dev-8-0 \
  cuda-cusolver-dev-8-0 \
  cuda-cusparse-dev-8-0 \
  cuda-driver-dev-8-0 \
  cuda-license-8-0 \
  cuda-misc-headers-8-0 \
  cuda-npp-dev-8-0 \
  cuda-nvgraph-dev-8-0 \
  cuda-nvml-dev-8-0 \
  cuda-nvrtc-dev-8-0 \
  git \
  libgoogle-glog-dev \
  libprotobuf-dev \
  protobuf-compiler \
  python-dev \
  python-tk \
  python-pip

RUN pip install --upgrade pip

RUN pip install \
  numpy \
  protobuf

ENV PATH=/usr/local/cuda-8.0/bin${PATH:+:${PATH}}
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64/:/usr/local/cuda-8.0/lib64\ ${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}

# Tensorflow installation
RUN pip install --upgrade tensorflow_gpu
